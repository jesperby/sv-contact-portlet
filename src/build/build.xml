<?xml version="1.0"?>

<!-- ======================================================================= -->
<!-- Build file                                                              -->
<!-- ======================================================================= -->

<project name="kontaktruta" default="compile-deploy" basedir="..">
   <!-- =================================================================== -->
   <!-- Initialization                                                      -->
   <!-- =================================================================== -->
   <target name="init">
      <property name="src.dir" value="${basedir}"/>

      <property name="build.dir" value="${basedir}/../build"/>
      <property name="dist.dir" value="${basedir}/../dist"/>

      <property file="${src.dir}/build/build.properties"/>
      <property file="${src.dir}/build/project.properties"/>
      <property file="${user.home}/${name}.properties"/>

      <property name="dest.dir" value="${sitevision.dir}/tomcat/webapps"/>
      <property name="war.dir" value="${build.dir}/${name}"/>

      <!-- =================================================================== -->
      <!-- Define class path                                                   -->
      <!-- =================================================================== -->
      <path id="project.class.path">
         <!-- Add portlet app jar files -->
         <fileset dir="${src.dir}/lib">
            <include name="**/*.jar"/>
         </fileset>

         <!-- append the external classpath lastly -->
         <pathelement path="${java.class.path}"/>
      </path>
   </target>

   <!-- =================================================================== -->
   <!-- Prepares the build directory                                        -->
   <!-- =================================================================== -->
   <target name="prepare" depends="init">
      <mkdir dir="${war.dir}/WEB-INF/classes"/>
      <mkdir dir="${war.dir}/WEB-INF/lib"/>
      <mkdir dir="${dist.dir}"/>
   </target>

   <!-- =================================================================== -->
   <!-- Compiles the source code                                            -->
   <!-- =================================================================== -->
   <target name="compile" depends="prepare">
		<javac srcdir="${src.dir}/java/wsclient"
			destdir="${war.dir}/WEB-INF/classes"
			debug="${compile.debug}"
			deprecation="${compile.deprecation}"
			optimize="${compile.optimize}"
			encoding="UTF-8">
			<classpath refid="project.class.path"/>
		</javac>
		<javac srcdir="${src.dir}/java/main"
		   destdir="${war.dir}/WEB-INF/classes"
		   debug="${compile.debug}"
		   deprecation="${compile.deprecation}"
		   optimize="${compile.optimize}"
			 encoding="UTF-8">
		   <classpath refid="project.class.path"/>
		</javac>
   </target>

   <!-- =================================================================== -->
   <!-- Copy web resources                                                  -->
   <!-- =================================================================== -->
   <target description="Copy web files" name="copy-web" depends="prepare">
      <!-- Copy libraries -->
      <copy todir="${war.dir}/WEB-INF/lib">
         <fileset dir="${src.dir}/lib/app"/>
      </copy>


      <!-- Copy web files -->
      <copy todir="${war.dir}">
         <fileset dir="${src.dir}/resources"/>
      </copy>
   	
   	  <!-- Workaround -->
   	  <copy todir="${war.dir}/WEB-INF/classes">
   	  	<fileset dir="${sitevision.dir}/tomcat/webapps/ROOT/WEB-INF/classes" includes="**/SSL*.class" />
   	  </copy>
   </target>

   <!-- =================================================================== -->
   <!-- Copy Java resources                                                 -->
   <!-- =================================================================== -->
   <target description="Copy Java resources" name="copy-resources" depends="prepare">
      <copy todir="${war.dir}/WEB-INF/classes">
         <fileset dir="${src.dir}/java" excludes="**/*.java"/>
      </copy>
   </target>

   <!-- =================================================================== -->
   <!-- Copy Dev properties                                                 -->
   <!-- =================================================================== -->
   <target description="Copy Dev properties" name="copy-prop-dev" depends="prepare">
      <copy todir="${war.dir}/WEB-INF">
         <fileset dir="${src.dir}/../config/dev/" />
      </copy>
   </target>

   <!-- =================================================================== -->
   <!-- Copy Test properties                                                 -->
   <!-- =================================================================== -->
   <target description="Copy Test properties" name="copy-prop-test" depends="prepare">
      <copy todir="${war.dir}/WEB-INF">
         <fileset dir="${src.dir}/../config/test/" />
      </copy>
   </target>

    <!-- =================================================================== -->
    <!-- Copy Prod properties                                                 -->
    <!-- =================================================================== -->
    <target description="Copy Prod properties" name="copy-prop-prod" depends="prepare">
       <copy todir="${war.dir}/WEB-INF">
          <fileset dir="${src.dir}/../config/prod/" />
       </copy>
    </target>


	
   <!-- =================================================================== -->
   <!-- Build WAR                                                           -->
   <!-- =================================================================== -->
   <target description="Create portlet application" name="create-war" depends="prepare">
      <zip zipfile="${dist.dir}/${name}.war">
         <fileset dir="${war.dir}"/>
      </zip>
   </target>

   <!-- =================================================================== -->
   <!-- Creates the application                                             -->
   <!-- =================================================================== -->
   <target description="Create portlet application" name="create-app" depends="prepare,compile,copy-web,copy-resources,create-war">
   </target>

   <!-- =================================================================== -->
   <!-- Create and redeploy                                                 -->
   <!-- =================================================================== -->
   <target description="Only compile" name="create-deploy" depends="prepare,create-app,deploy">
   </target>

   <!-- =================================================================== -->
   <!-- Compile and redeploy                                                -->
   <!-- =================================================================== -->
   <target description="Only compile" name="compile-deploy" depends="clean,copy-prop-dev,create-app,deploy">
   </target>

   <!-- =================================================================== -->
   <!-- Compile and redeploy                                                -->
   <!-- =================================================================== -->
   <target description="Compile-Deploy-Dev" name="compile-deploy-dev" depends="clean,copy-prop-dev,create-app,deploy-dev">
   </target>	

   <!-- =================================================================== -->
   <!-- Compile and redeploy                                                -->
   <!-- =================================================================== -->
   <target description="Compile-Deploy-Test" name="compile-deploy-test" depends="clean,copy-prop-test,create-app">
   </target>	

   <!-- =================================================================== -->
   <!-- Compile and redeploy                                                -->
   <!-- =================================================================== -->
   <target description="Compile-Deploy-Prod" name="compile-deploy-prod" depends="clean,copy-prop-prod,create-app">
   </target>	
	
   <!-- =================================================================== -->
   <!-- Redeploy                                                            -->
   <!-- =================================================================== -->
   <target description="Deploy" name="deploy" depends="prepare">
      <!-- Touch descriptor to redeploy, if deployed in exploded mode -->
   	  
	  <delete dir="${dest.dir}/${name}"/>   	
      <copy todir="${dest.dir}" file="${dist.dir}/${name}.war"/>
      <touch file="${dest.dir}/${name}.war"/>
      
   	 <!-- <scp localFile="${dist.dir}/${name}.war" remoteTodir="XXX@192.168.59.10:/opt/sitevision/custom" trust="true" password="XXX" verbose="true"/>
   	  <sshexec host="192.168.59.10"
   		username="XXX"
   		password="XXX"
   		command="mv /opt/sitevision/custom/${name}.war /opt/sitevision/custom/deploy" trust="true"/> -->

   </target>

   <!-- =================================================================== -->
   <!-- Redeploy - Dev                                                      -->
   <!-- =================================================================== -->
   <target description="Deploy-Dev" name="deploy-dev" depends="prepare">
   	<!--
   	  <scp localFile="${dist.dir}/${name}.war" remoteTodir="XXX@sitevision.dev.malmo.se:/opt/sitevision/custom" trust="true" password="XXXX" verbose="true"/>
   	  <echo message="Moving ${name}.war to custom/deploy" />
   	  <sshexec host="sitevision.dev.malmo.se"
   		username="XXX"
   		password="XXX"
   		command="mv /opt/sitevision/custom/${name}.war /opt/sitevision/custom/deploy" trust="true"/>
   	-->
   </target>

   <!-- =================================================================== -->
   <!-- Redeploy - Test                                                     -->
   <!-- =================================================================== -->
   <target description="Deploy-Test" name="deploy-test" depends="prepare">
   	<!--
   	  <scp localFile="${dist.dir}/${name}.war" remoteTodir="XXX@www.test.malmo.se:/opt/sitevision/custom" trust="true" password="XXX" verbose="true"/>
   	  <echo message="Moving ${name}.war to custom/deploy" />
   	  <sshexec host="www.test.malmo.se"
   		username="XXX"
   		password="XXX"
   		command="mv /opt/sitevision/custom/${name}.war /opt/sitevision/custom/deploy" trust="true"/>
   	-->
   </target>

   <!-- =================================================================== -->
   <!-- Redeploy - Prod                                                     -->
   <!-- =================================================================== -->
   <target description="Deploy-Prod" name="deploy-prod" depends="prepare">
   	<!--
 	  <scp localFile="${dist.dir}/${name}.war" remoteTodir="XXX@sitevision.dev.malmo.se:/tmp/prod/opt_sitevision_custom_deploy" trust="true" password="XXX" verbose="true"/>	    
   	  <scp localFile="${dist.dir}/${name}.war" remoteTodir="root@www.malmo.se:/opt/sitevision/custom" trust="true" password="happyuser2" verbose="true"/>
   	  <echo message="Moving ${name}.war to custom/deploy" />
   	  <sshexec host="www.malmo.se"
   		username="XXX"
   		password="XXX"
   		command="mv /opt/sitevision/custom/${name}.war /opt/sitevision/custom/deploy" trust="true"/>
   	  -->
   </target>
	
   <!-- =================================================================== -->
   <!-- Cleans up generated stuff                                           -->
   <!-- =================================================================== -->
   <target name="clean" depends="init">
      <delete dir="${build.dir}"/>
      <delete dir="${dist.dir}"/>
   </target>
</project>
